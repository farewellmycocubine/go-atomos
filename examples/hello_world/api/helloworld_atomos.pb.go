// Code generated by protoc-gen-go-atomos. DO NOT EDIT.

package api

import (
	atomos "github.com/hwangtou/go-atomos"
	proto "google.golang.org/protobuf/proto"
)

// This is a compile-time assertion to ensure that this generated file
// is compatible with the atomos package it is being compiled against.

//
// Interface
//

// GreeterId is the interface of Greeter atomos.
//
type GreeterId interface {
	atomos.Id
	//SpawnGretter(from atomos.Id, arg *HelloInit) error
	SayHello(from atomos.Id, in *HelloRequest) (*HelloReply, error)
}

func GetGreeterId(c atomos.CosmosNode, name string) (GreeterId, error) {
	ca, err := c.GetAtomId("Greeter", name)
	if err != nil { return nil, err }
	if c, ok := ca.(GreeterId); ok { return c, nil } else { return nil, atomos.ErrAtomType }
}

// GreeterAtom is the atomos implements of Greeter atomos.
//
type GreeterAtom interface {
	atomos.Atom
	SayHello(from atomos.Id, in *HelloRequest) (*HelloReply, error)
}

// TODO: Customize argument type.
func SpawnGreeter(c atomos.CosmosNode, actorName string, arg proto.Message) (GreeterId, error) {
	_, err := c.SpawnAtom("Greeter", actorName, arg)
	if err != nil { return nil, err }
	id, err := c.GetAtomId("Greeter", actorName)
	if err != nil { return nil, err }
	if i, ok := id.(GreeterId); ok { return i, nil }
	return nil, atomos.ErrAtomType
}

//
// Impelement
//

type greeterId struct {
	atomos.Id
}

//func (c *greeterId) SpawnGreeter(atomName string, arg *HelloInit) error {
//
//}

func (c *greeterId) SayHello(from atomos.Id, in *HelloRequest) (*HelloReply, error) {
	r, err := c.Cosmos().MessageAtom(from, c, "SayHello", in)
	if err != nil { return nil, err }
	reply, ok := r.(*HelloReply)
	if !ok { return nil, atomos.ErrAtomMessageReplyType }
	return reply, nil
}

func GetGreeterInterface(dev atomos.ElementDevelop) *atomos.ElementInterface {
	elem := atomos.NewInterfaceFromDevelop(dev)
	elem.Config.Messages = map[string]*atomos.AtomMessageConfig{
		"SayHello": atomos.NewAtomCallConfig(&HelloRequest{}, &HelloReply{}),
	}
	elem.AtomIdConstructor = func(c atomos.CosmosNode, atomName string) (atomos.Id, error) {
		id, err := atomos.NewAtomId(c, "Greeter", atomName)
		if err != nil { return nil, err } else { return &greeterId{id}, nil }
	}
	elem.AtomCalls = map[string]*atomos.ElementAtomMessage{
		"Spawn": {// TODO
		},
		"SayHello": {
			InDec: func(b []byte) (proto.Message, error) { return atomos.MessageUnmarshal(b, &HelloRequest{}) },
			OutDec: func(b []byte) (proto.Message, error) { return atomos.MessageUnmarshal(b, &HelloReply{}) },
		},
	}
	return elem
}

func GetGreeterImplement(dev atomos.ElementDevelop) *atomos.ElementImplementation {
	elem := atomos.NewImplementationFromDevelop(dev)
	elem.ElementInterface = GetGreeterInterface(dev)
	elem.AtomHandlers = map[string]atomos.MessageHandler{
		"SayHello": func(from atomos.Id, to atomos.Atom, in proto.Message) (proto.Message, error) {
			req, ok := in.(*HelloRequest)
			if !ok { return nil, atomos.ErrAtomMessageArgType }
			a, ok := to.(GreeterAtom)
			if !ok { return nil, atomos.ErrAtomMessageAtomType }
			return a.SayHello(from, req)
		},
	}
	return elem
}
